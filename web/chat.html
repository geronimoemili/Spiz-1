<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPIZ ¬∑ Chat Qualitativa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #f3f6fc; height: 100vh; display: flex; flex-direction: column; }
        .chat-container { max-width: 1000px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; height: 100vh; }
        .chat-header { background: white; border-radius: 30px 30px 0 0; padding: 24px; border-bottom: 1px solid #e9eef3; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px; background: white; }
        .chat-input-area { background: white; border-radius: 0 0 30px 30px; padding: 24px; border-top: 1px solid #e9eef3; }
        .message-user { background: #003366; color: white; border-radius: 20px 20px 4px 20px; padding: 12px 18px; max-width: 70%; align-self: flex-end; }
        .message-ai { background: #f0f4fa; border-radius: 20px 20px 20px 4px; padding: 12px 18px; max-width: 70%; }
        .timestamp { font-size: 0.7rem; opacity: 0.6; margin-top: 4px; }
        .btn-outline-primary { border-color: #003366; color: #003366; }
        .btn-outline-primary:hover { background: #003366; color: white; }
    </style>
</head>
<body>

<div class="chat-container p-3">
    <div class="chat-header d-flex justify-content-between align-items-center">
        <h4 class="fw-bold m-0" style="color: #003366;">üß† SPIZ ¬∑ Analisi Qualitativa</h4>
        <a href="/" class="btn btn-outline-primary rounded-pill px-4">
            ‚Üê Dashboard quantitativa
        </a>
    </div>

    <div class="chat-messages d-flex flex-column" id="chat-messages">
        <div class="message-ai align-self-start mb-3">
            <strong>SPIZ:</strong> Ciao, sono la tua AI per analisi qualitative. Fammi domande complesse su sentiment, trend, rischi, report strategici.
        </div>
    </div>

    <div class="chat-input-area">
        <div class="input-group">
            <input type="text" id="message-input" class="form-control form-control-lg" 
                   placeholder="Es: Analizza l'evoluzione del sentiment su Mediobanca..." 
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn btn-primary px-4" onclick="sendMessage()">Invia</button>
        </div>
        <div class="mt-2 d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="suggest('Fammi un report strategico su Mediobanca')">üìä Report Mediobanca</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="suggest('Quali sono i rischi emergenti per Snam?')">‚ö†Ô∏è Rischi Snam</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="suggest('Confronta la copertura di Mediobanca e Intesa')">üîÑ Confronto</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="suggest('reset')">üîÑ Reset chat</button>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-messages');
    let sessionId = 'chat-' + Math.random().toString(36).substring(2);

    function addMessage(text, isUser) {
        const div = document.createElement('div');
        div.className = isUser ? 'message-user align-self-end mb-3' : 'message-ai align-self-start mb-3';
        div.innerHTML = isUser ? text : `<strong>SPIZ:</strong> ${text}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, true);
        input.value = '';

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text,
                    session_id: sessionId 
                })
            });
            const data = await res.json();
            addMessage(data.response, false);
        } catch (err) {
            addMessage('Errore di connessione', false);
        }
    }

    function suggest(q) {
        if (q === 'reset') {
            sessionId = 'chat-' + Math.random().toString(36).substring(2);
            chatBox.innerHTML = '';
            addMessage('Conversazione resettata. Come posso aiutarti?', false);
            return;
        }
        document.getElementById('message-input').value = q;
        sendMessage();
    }

    // Comando reset via chat
    window.sendMessage = sendMessage;
</script>
</body>
</html>